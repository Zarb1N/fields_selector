<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Demo</title>
    <meta name="description" content="Example">
    <meta name="Keywords" content="">

    <meta name="viewport" content="width=device-width, initial-scale=0.8">
    <!--
    <meta name="viewport" content="initial-scale=0.75, width=device-width, user-scalable=yes, minimum-scale=0.7, maximum-scale=1.0">
    -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    <!-- maplibre -->
    <link rel="stylesheet" href="/include/css/mapbox-gl.css" />
    <script src="/include/js/maplibre-gl.js"></script>

    <script src="/include/js/turf.min.js"></script>
    <script src="/include/js/mapbox-gl-draw.js"></script>
    <link rel="stylesheet" href="/include/css/mapbox-gl-draw.css" type="text/css">
    <!--
    <script src="/js/mapbox-gl-draw-passing-mode.js"></script>
    <script src="/js/mapbox-gl-draw-split-polygon-mode.js"></script>
    -->

    <!-- jquery -->
    <script src="https://code.jquery.com/jquery-2.2.4.min.js"
        integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>
    <!-- bootstrap -->

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-b5kHyXgcpbZJO/tY9Ul7kGkf1S0CWuKcCD38l8YkeH8z8QjE0GmW1gYU5S9FOnJ0"
        crossorigin="anonymous"></script>
    <!--
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.47/css/bootstrap-datetimepicker-standalone.css" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.47/css/bootstrap-datetimepicker-standalone.min.css" />
    <script data-require="MomentJS@2.10.0" data-semver="2.10.0" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.10.6/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.47/js/bootstrap-datetimepicker.min.js"></script>
    -->
    <link rel='stylesheet' href="/include/css/main.css" type='text/css' />

    <script src="/include/js/bright_maptiler.js"></script>
    <script src="/include/js/main_map.js"></script>
    <script src="/include/js/thumbnail.js"></script>
    <script src="/include/js/form.js"></script>

    <link href="/include/css/validation.min.css" rel="stylesheet">
    <script src="/include/js/validation.min.js"></script>


    <style>
        
    </style>
</head>

<body>
    <div class="content">
        <div class="" id="geocontainer">
            <div id="mymap">
                <!--
                <nav id="menu"></nav>
                -->
                <div class="map-overlay" id='selarea'>
                    <h2 class="accordion__highlighted">Площадь выбранных конутров</h2>
                    <div id="sarea">
                        <!-- <p id="maxarea">Площадь по договору <b>1000</b> Га</p> -->
                    </div>
                    <div id='pdd'>
                        <p>Укажите мышкой конутр вашего поля, если поля нет на карте, нарисуйте конутр</p>
                    </div>
                </div>
            </div>
            <!--
            <button class="btn btn btn-primary" id="editbtn" onclick="SetEditMode()">Изменить</button>
            -->
            <label class="label-checkbox" id="editbtn" onchange="SetEditMode()">
                <input type="checkbox">
                <span>Изменить</span>
            </label>
            <button class="btn btn btn-primary" id="closebtn" onclick="hideMap()">Завершить</button>

        </div>

        <div class="sidepanel" id="mySidepanel">
            <h2 class="accordion__header" id="" >
                Рассчитать стоимость страхования
            </h2> 
            <form class="accordion__body form" id="form" name="form" onsubmit="validation.isValid() && sendForm(this); return false">
                <div class="form__fields-choosing">
                    <div class="form__header">
                        <div class="form__title">Выбранные поля</div>
                        <button 
                            class="btn btn-primary btn-sm" 
                            type="button" 
                            id="button-addon3" 
                            onclick="showMap()">
                            Укажите поля на карте
                        </button>
                    </div>
                    <ul id="accordion__list">
                        <li class="accordion__list-item accordion__highlighted"> <div>Номер поля</div>  <div>Площадь поля</div></li>
                        <li class="accordion__list-item"><div style="grid-column: 1 / -1;">Вы еще не выбрали ни одного поля</div></li>
                    </ul>
                </div>
                <div class="error-messages"></div>
                
                <div class="form__item">
                    <div>Адрес электронной почты</div>
                    <input 
                        type="email"
                        id="email"
                        class="validate"
                        data-validate="required, email"
                    >
                </div>
                <div class="form__item">
                    <div>Номер телефона</div>
                    <input 
                        type="tel"
                        id="tel"
                        class="validate"
                        data-validate="required, phoneNumber"
                    >
                </div>
                <div class="form__item">
                    <div>ИНН</div>
                    <input 
                        type="text"
                        name="taxpayerIdntificator"
                        id="taxpayerIdntificator"
                        class="validate"
                        data-validate="required, taxpayerIdntificator"
                    >
                </div>
                <div class="form__actions">
                    <button 
                        class="btn btn-secondary form__submit-btn" 
                        type="button" 
                        onclick="cancelForm()"
                    >
                        Отменить
                    </button>
                    <div></div>
                    <button 
                        class="btn btn-primary form__submit-btn" 
                        type="submit" 
                        name="submit"
                    >
                        Заказать контуры
                    </button>
                </div>
            </form>
            <!-- <div class="accordion accordion-flush" id="accordionFlushExample">
                <h2 class="accordion-header" id="" style="padding: 60px;">
                    Рассчитать стоимость страхования
                </h2>
                <div class="accordion-item">
                    <h2 class="accordion-header" id="flush-headingOne">
                        <button class="accordion-button collapsed" type="submit" data-bs-toggle="collapse"
                            data-bs-target="#flush-collapseOne" aria-expanded="false" aria-controls="flush-collapseOne">
                            Шаг 1. Введите номер договора страхования
                        </button>
                    </h2>
                    <div id="flush-collapseOne" class="accordion-collapse collapse" aria-labelledby="flush-headingOne"
                        data-bs-parent="#accordionFlushExample">
                        <div class="accordion-body">
                            <div class="input-group mb-3">
                                <input id="enshnum" type="text" class="form-control" placeholder="Номер договора"
                                    aria-label="Номер договора">
                                <div class="invalid-feedback">
                                    Ведите номер договора страхования
                                </div>
                                <input id="enshdate" type="date" class="form-control" placeholder="Дата договора"
                                    aria-label="Дата договора" aria-describedby="button-addon2">
                                <button id="qbase" class="btn btn-outline-secondary" type="button"
                                    onclick="findagr()">Найти</button>
                            </div>
                            <div class="input-group mb-3">
                                <input id="uname" type="text" class="form-control" placeholder="Ф.И.О. Страхователя"
                                    aria-label="Ф.И.О. Страхователя" disabled>
                                <input id="uarea" type="text" class="form-control" placeholder="Площадь страхования"
                                    aria-label="Площадь страхования" disabled>
                                <input id="ureg" type="text" class="form-control" placeholder="Субъект РФ"
                                    aria-label="Субъект РФ" disabled>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="accordion-item">
                    <h2 class="accordion-header" id="flush-headingTwo">
                        <button class="accordion-button collapsed" type="button" id="setprop" data-bs-toggle="collapse"
                            data-bs-target="#flush-collapseTwo" aria-expanded="false" aria-controls="flush-collapseTwo">
                            Шаг 2. Заполните информацию о Ваших полях
                        </button>
                    </h2>
                    <div id="flush-collapseTwo" class="accordion-collapse collapse" aria-labelledby="flush-headingTwo"
                        data-bs-parent="#accordionFlushExample">
                        <div class="accordion-body" id="fields">
                            <button class="btn btn-primary" type="button" id="button-addon3" onclick="showMap()">Укажите
                                поля на карте</button>
                            <div class="fields__form fields__form--invisible">
                                <div>Выбранные поля</div>
                                <div>Площадь выбранные полей <span id="fields__areas-sum"></span></div>
                                <div>Сумма к оплате <span id="fields__amount-to-be-paid"></span></div>
                                <div>Адрес электронной почты</div>
                                <div>Номер телефона</div>
                                <div>ИНН</div>
                            </div>
                        </div>
                        <div>
                            <hr>
                            <button class="btn btn-primary" type="button" id="button-submit-fields"
                                onclick="updatemeta()">Подтвердить корректность данных</button>
                        </div>
                    </div>
                </div>

                <div class="accordion-item">
                    <h2 class="accordion-header" id="flush-headingThree">
                        <button class="accordion-button collapsed" type="button" id="sendreq" data-bs-toggle="collapse"
                            data-bs-target="#flush-collapseThree" aria-expanded="false"
                            aria-controls="flush-collapseThree">
                            Шаг 3. Укажите дату и тип ЧС
                        </button>
                    </h2>
                    <div id="flush-collapseThree" class="accordion-collapse collapse"
                        aria-labelledby="flush-headingThree" data-bs-parent="#accordionFlushExample">
                        <div class="accordion-body">
                            <div class="input-group mb-2">
                                <div style="width: 40%;">
                                    <label for="emer_name" style="margin: 5px;">Дата ЧС:</label>
                                    <input type="date" class="form-control" id="emer_date" aria-label="Дата ЧС">
                                </div>
                                <div style="width: 60%;">
                                    <label for="emer_type" style="margin: 5px;">Тип ЧС:</label>
                                    <select type="text" class="form-control" id="emer_type" aria-label="Тип ЧС" value=0>
                                        <option value=0>Не задано</option>
                                        <option value=1>Засуха атмосферная</option>
                                        <option value=2>Засуха почвенная</option>
                                        <option value=3>Заморозки</option>
                                        <option value=4>Вымерзание</option>
                                        <option value=5>Выпревание</option>
                                        <option value=6>Градобитие</option>
                                        <option value=7>Пыльная буря</option>
                                        <option value=8>Песчаная буря</option>
                                        <option value=9>Землетрясение</option>
                                        <option value=10>Лавина</option>
                                        <option value=11>Сель</option>
                                        <option value=12>Переувлажнение почвы</option>
                                        <option value=13>Выпирание</option>
                                        <option value=14>Раннее появление или установление снежного покрова</option>
                                        <option value=15>Половодье</option>
                                        <option value=16>Паводок</option>
                                        <option value=17>Ледяная корка</option>
                                        <option value=18>Промерзание верхнего слоя почвы</option>
                                        <option value=19>Пожар</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                    <button class="btn btn-primary me-md-2" type="button" id="submit" onclick="sendresult()">Отправить
                        заявку</button>
                </div>
                <div>
                    <hr>
                </div>
            </div> -->

        </div>
        <script>
            validation.init("form");

            const form = document.querySelector('#form')
            // form.addEventListener('submit', (e) => {
            //     sendForm(e)
            //     e.preventDefault()
            // })
            const server = ''
            let cropAreaSum
            let paymentSum 
            let fields = []
            let errMessage

            function sendForm(e) {
                const userInfo = {
                    email: e.email.value,
                    phone: e.tel.value,
                    taxpayerIdntificator: e.taxpayerIdntificator.value
                }
                if (fields.length !== 0) {
                    
                    fetch(`${server}`, {
                        method: 'POST',
                        headers: {
                            'Content-type': 'application/json',
                        },
                        body: JSON.stringify({
                            fields,
                            cropAreaSum,
                            paymentSum,
                            userInfo
                        })
                    })
                    console.log('sended')
                    return false

                }
                else {
                    errMessage = 'Сначала выберите поля!'
                    document.querySelector('.error-messages').innerHTML = errMessage
                }                
            }
            function cancelForm() {
                //window.location.reload()
                return false
                cropAreaSum = 0
                paymentSum = 0
                fields = []
                document.form.email.value = '',
                document.form.tel.value = '',
                document.form.taxpayerIdntificator.value = ''
            }

            /*
            var map = init_map();
            map.on('click', 'draw', function (e) {
                return;
            });
            */
            var map = init_map();
            function showMap() {
                document.getElementById("mymap").style.display = "inline";
                document.getElementById("mySidepanel").style.width = "0";
                map.resize();
            };
            /*
                function update_draw() {
                    if(ft_buffer){
                        ft_buffer.properties.crop_area = parseFloat($("#crop_area").val());
                        ft_buffer.properties.crop = {"name":$("#crop_name option:selected").text(),"code":parseInt($("#crop_name").val())}
                        //ft_buffer.properties.saw = {"start":$("#sdate").val(),"end":$("#edate").val()}
                        draw.add(ft_buffer);
                        popup.remove();
                        updateArea();
                    }
                };
            */
            function SetEditMode() {
                if (editmode == false) {
                    editmode = true;
                    map.setLayoutProperty(
                        'cosmetic',
                        'visibility',
                        'none'
                    );
                    map.addControl(draw);
                    var data = map.getSource('cosmetic')._data;
                    draw.add(data);
                    $('#closebtn').prop('disabled', true);
                }
                else {
                    editmode = false;
                    cosmetic_geojson = draw.getAll();
                    map.setLayoutProperty(
                        'cosmetic',
                        'visibility',
                        'visible'
                    );
                    for (var i = 0; i < cosmetic_geojson.features.length; i++) {
                        var geom = cosmetic_geojson.features[i].geometry
                        if (!("id" in cosmetic_geojson.features[i].properties))
                            cosmetic_geojson.features[i].properties.id = cosmetic_geojson.features[i].id
                        if (!("area" in cosmetic_geojson.features[i].properties))
                            cosmetic_geojson.features[i].properties.area = Math.round((turf.area(geom) / 10000) * 100) / 100;
                        if (!("crop_area" in cosmetic_geojson.features[i].properties))
                            cosmetic_geojson.features[i].properties.crop_area = cosmetic_geojson.features[i].properties.area;
                    }
                    map.getSource('cosmetic').setData(cosmetic_geojson);
                    map.moveLayer('cosmetic');
                    map.removeControl(draw);
                    $('#closebtn').prop('disabled', false);
                }
            }

            function update_draw() {
                if (ft_buffer) {
                    ft_buffer.properties.crop_area = parseFloat($("#crop_area").val());
                    ft_buffer.properties.crop = { "name": $("#crop_name option:selected").text(), "code": parseInt($("#crop_name").val()) }
                    //ft_buffer.properties.saw = {"start":$("#sdate").val(),"end":$("#edate").val()}
                    //draw.add(ft_buffer);
                    cosmetic_geojson.features.push(ft_buffer);
                    map.getSource('cosmetic').setData(cosmetic_geojson);
                    map.moveLayer('cosmetic');
                    popup.remove();
                    updateArea();
                }
            };

            /*
                function updateMeta(e){
                    updateArea(e);
                    ft_buffer = e.features[0];
                    var ft_area = (Math.round((turf.area(ft_buffer)/10000) * 100) / 100);
                    lngLat = turf.centroid(ft_buffer).geometry.coordinates;
                    //var popup_e = new mapboxgl.Popup();
                    popup
                        .setLngLat(lngLat)
                        .setHTML(
                            "<div class='container'>"+
                                  "<div class='form-group'>"+
                                    "<p>Площадь контура Га: <b>"+ft_area+"</b></p>"+
                                    "<label for='crop_area'>Площадь посева Га:</label>"+
                                    "<input type='number' class='form-control' name='crop_area' id='crop_area'>"+
                                    "<label for='crop_name'>Культура:</label>"+
                                    "<select class='form-control' id='crop_name' name='crop_name' >"+
                                        get_croplist()+
                                      "<option value=13>Сахарная свекла</option>"+
                                    "</select>"+
                                  "</div>"+
                                  "<button type='submit' style='float:left' onclick='update_draw()'>Сохранить</button>"+
                                  "<button type='submit' style='float:right' onclick='popup.remove()'>Отмена</button>"+
                            "</div>"
                        ).addTo(map);
                    $("#crop_area").val(ft_area);
                    $("#crop_name").focus();
                };
            */

            function updateMeta(e) {

            }

            function updateArea(e) {
                //var data = draw.getAll();
                if (editmode === false)
                    var data = map.getSource('cosmetic')._data;
                else
                    var data = draw.getAll();

                var answer = document.getElementById('pdd');
                console.log(data)
                if (data.features.length > 0) {
                    var area = turf.area(data) / 10000;
                    // restrict to area to 2 decimal points
                    var rounded_area = Math.round(area * 100) / 100;
                    answer.innerHTML =
                        '<p>Площадь выбранных контуров <strong><b>' +
                        rounded_area +
                        '</b></strong> Га</p>';
                } else {
                    answer.innerHTML = '';
                    /*
                    if (e.type !== 'draw.delete')
                        alert('Use the draw tools to draw a polygon!');
                    */
                }

                // var insurance_area = parseFloat($("#uarea").val().split(" ")[0]);
                // var maxarea = insurance_area + insurance_area * 0.1;
                // if (area > maxarea)
                //     $("#pdd").css("color", "red");
                // else
                //     $("#pdd").css("color", "black");
            };

            function hideMap() {
                //bad logic
                // if ($("#pdd").css("color") == "rgb(255, 0, 0)") {
                //     alert("Площадь конутров превышает площадь страхования, скорректируйте контуры");
                //     return;
                // }

                // document.getElementById("mymap").style.display = "none";
                document.getElementById("mySidepanel").style.width = "100%";
                // document.getElementById('setprop').disabled = false;
                // document.getElementById('setprop').disabled = false;



                //var data = draw.getAll();
                var data = map.getSource('cosmetic')._data;
                var onform = [];
                var curids = [];
                document.querySelector('.error-messages').innerHTML = ''
                cropAreaSum = 0
                paymentSum = 0
                fields = []
                const fieldsList = document.querySelector('#accordion__list')
                
                fieldsList.innerHTML = '<li class="accordion__list-item accordion__highlighted"> <div>Номер поля</div>  <div>Площадь поля</div></li>'
                data.features.forEach( field => {
                    fieldsList.innerHTML += `<li class="accordion__list-item"> <div> ${field.properties.id} </div> <div> ${field.properties.crop_area.toFixed(2)} га </div></li>`
                    cropAreaSum += field.properties.crop_area
                    fields.push(field.properties)
                })
                
                if (cropAreaSum < 500) {
                    paymentSum = 0
                }
                else if (cropAreaSum < 5000) {
                    paymentSum = cropAreaSum * 6
                }
                else if (cropAreaSum < 15000) {
                    paymentSum = cropAreaSum * 4
                }
                else if (cropAreaSum >= 15000) {
                    paymentSum = cropAreaSum * 2
                }
                else {
                    paymentSum = undefined
                }
                if (fields.length !== 0) {
                    fieldsList.innerHTML += `<li class="accordion__list-item accordion__highlighted"> <div> Суммарная площадь </div> <div> ${cropAreaSum.toFixed(2)} га </div></li>`
                    fieldsList.innerHTML += `<li class="accordion__list-item accordion__highlighted"> <div> Сумма к оплате </div> <div> ${paymentSum.toFixed(0)} руб. </div></li>`
                }
                else {
                    fieldsList.innerHTML += `<li class="accordion__list-item"><div style="grid-column: 1 / -1;">Вы еще не выбрали ни одного поля</div></li>`
                }
                console.log(data)




                const elementsArray = document.getElementsByClassName('pannel');
                for (var i = 0; i < elementsArray.length; i++) {
                    onform[i] = elementsArray[i].id;
                };
                for (let i = 0; i < data.features.length; i++) {
                    var pid = data.features[i].properties.id;
                    var area = turf.area(data.features[i]) / 10000;
                    curids[i] = pid;

                    var rounded_area = Math.round(area * 100) / 100;
                    if (document.getElementById(pid)) {
                        //document.getElementById("area_"+pid).value=rounded_area;
                        continue;
                    };
                    data.features[i].properties.area = rounded_area
                    //createForm(pid, data.features[i]);
                };
                var toremove = onform.filter(x => !curids.includes(x));
                for (var i = 0; i < toremove.length; i++) {
                    document.getElementById(toremove[i]).remove();
                };
                $("#sendreq").prop("disabled", false);
                $("#submit").prop("disabled", false);
                $("#button-submit-fields").prop("disabled", false);
            };

            function findagr() {
                $("#uname").val("Иванов. И.П.");
                $("#uarea").val("600 Га");
                $("#ureg").val("Белгородская область");
                $("#setprop").prop("disabled", false);
            };

            $(document).ready(function () {
                $("#setprop").prop("disabled", true);
                $("#sendreq").prop("disabled", true);
                $("#submit").prop("disabled", true);
                $("#button-submit-fields").prop("disabled", true);
            });



            /*
            $( "#submit" ).click(function( event ) {
                alert( "Заявка отправлена" );
            });
            */
            /*
                $(function() {
                    $('.mydatetimepicker').datetimepicker({locale: 'ru'});
                });
            */
//$('.mydatetimepicker').data("DateTimePicker").FUNCTION();
        </script>
</body>

</html>